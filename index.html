<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <style>
      #messages-container {
        overflow: scroll;
        background: rgba(0, 240, 0, 0.2);
        height: 400px;
      }
    .message-header {
      font-weight: bold;
    }
    </style>
  </head>
  <body>
    <div id="container" class="container">
			<header><h1>GYLT chatroom</h1></header>
      <div id="messages-container" class="row"></div>
      <div id="inputs-container">
        <div class="row">
          <div class="col-sm-6">
            <div class="form-group">
    					<label for="name">Name</label>
    					<input type="text" class="form-control" id="name" placeholder="Enter name">
					  </div>
            <div class="form-group">
    					<label for="search">Gif Search</label>
              <input id="search" class="form-control" type="text" placeholder="Enter a word or phrase" />
              <span class="input-group-btn">
                <button class="btn btn-secondary" type="button" id="enter-btn">Enter</button>
              </span>
            </div>
						<div id="errors"></div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-database.js"></script>

    <script>
      // Initialize Firebase
      const config = {
        apiKey: "AIzaSyBSgKVQqRrhMEW4aEQJj40p6fOrAeBll98",
        authDomain: "flip-game-flex-app.firebaseapp.com",
        databaseURL: "https://flip-game-flex-app.firebaseio.com",
      };
      firebase.initializeApp(config);

      const messagesRef = firebase.database().ref('gylt/messages');
      messagesRef.on('child_added', snapshot => {
        console.log('child added', snapshot.val());
        messagesObject = snapshot.val();
        appendMessage(messagesObject);
      });

    const messagesContainer = document.getElementById('messages-container');
		const submitBtn = document.getElementById('enter-btn');
		const errors = document.getElementById('errors');
		
    const url = 'https://api.giphy.com/v1/gifs/translate?api_key=e358a4d723f946318f7a53b1e05b8dab&s=';

    submitBtn.addEventListener('click', () => {
			const text = document.getElementById('search').value;
			const author = document.getElementById('name').value;

			if (text === "" || author === "") return;

			errors.innerHTML = '';
			
			fetch(`${url}${text}`).then(r => r.json())
			.then(res => {
				if (res.data && res.data.length < 1) {
					errors.innerText = `No gifs found for: ${text}`;
					return;
				}

				console.log('giphy returned', res);
				const gifUrl = res.data.images.fixed_height.url;
				const msgRef = firebase.database().ref('gylt/messages').push().set({
					author: author,
					text: text,
					gifUrl: gifUrl
				});
			});
		});

    function appendMessage(obj) {
      const msg = document.createElement('div');
      const msgHeader = document.createElement('div');
      const msgBody = document.createElement('div');

      msg.classList.add('col-lg-12', 'message');
      msgHeader.classList.add('message-header');
      msgBody.classList.add('message-body');

      msgHeader.innerHTML = obj.author;
      msgBody.innerHTML = obj.text;

      msg.appendChild(msgHeader);
      msg.appendChild(msgBody);

      messagesContainer.appendChild(msg);

      if (obj.gifUrl) {
        const img = document.createElement('img');
        img.src = obj.gifUrl;
				msg.style.height = '270px';
        msg.appendChild(img);
      }

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    </script>

    <script>
      const button = document.getElementById('search-btn');

    </script>
  </body>
</html>
